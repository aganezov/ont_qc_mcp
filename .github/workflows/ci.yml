name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[all]"

      - name: Ruff lint
        run: ruff check .

      - name: Type check (mypy)
        run: mypy ont_qc_mcp tests

      - name: Security scan (bandit)
        run: bandit -r ont_qc_mcp -x tests

      - name: Dependency audit (pip-audit)
        run: pip-audit

      - name: Unit tests (skip integration)
        run: pytest --cov=ont_qc_mcp --cov-report=xml

  integration:
    name: Integration (${{ matrix.runtime }} / ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            runtime: docker
          - os: ubuntu-24.04-arm
            arch: arm64
            runtime: docker
          - os: ubuntu-latest
            arch: x86_64
            runtime: apptainer
          - os: ubuntu-24.04-arm
            arch: arm64
            runtime: apptainer
    env:
      MCP_IGV_MOCK: "0"
      MCP_IGV_CONTAINER_IMAGE: "aganezov/igv_snapper:0.2"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up micromamba with bioinformatics CLIs
        uses: mamba-org/setup-micromamba@v2
        with:
          micromamba-version: "latest"
          environment-name: ci
          init-shell: bash
          condarc: |
            channels:
              - conda-forge
              - bioconda
            channel_priority: strict
          create-args: >-
            python=3.11 chopper cramino mosdepth=0.3.12 samtools bcftools
          cache-environment: true
          cache-downloads: true

      - name: Set up Rust (for nanoq)
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        shell: bash -l {0}
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[all]"

      - name: Install nanoq via cargo
        shell: bash -l {0}
        run: cargo install --locked nanoq

      - name: Check installed CLI versions
        shell: bash -l {0}
        run: |
          echo "=== System Architecture ==="
          uname -m
          echo ""
          echo "=== Tool Versions ==="
          chopper --version
          cramino --version
          mosdepth --version
          samtools --version
          bcftools --version
          nanoq --version
          echo ""
          echo "=== Verify mosdepth binary architecture ==="
          MOSDEPTH_PATH=$(which mosdepth)
          echo "mosdepth path: $MOSDEPTH_PATH"
          file "$MOSDEPTH_PATH" || echo "file command not available"
          echo ""
          echo "=== Quick mosdepth execution test ==="
          mosdepth --help | head -3 || echo "mosdepth help failed"

      - name: Pull IGV container image
        if: matrix.runtime == 'docker'
        run: docker pull ${{ env.MCP_IGV_CONTAINER_IMAGE }}

      - name: Install Apptainer (system)
        if: matrix.runtime == 'apptainer'
        run: |
          sudo apt-get update
          sudo apt-get install -y apptainer
          mkdir -p .ci-bin
          cat > .ci-bin/apptainer <<'EOF'
          #!/usr/bin/env bash
          exec sudo --preserve-env=APPTAINER_CACHEDIR,APPTAINER_TMPDIR,APPTAINER_DISABLE_CACHE /usr/bin/apptainer "$@"
          EOF
          chmod +x .ci-bin/apptainer
          echo "APPTAINER=$GITHUB_WORKSPACE/.ci-bin/apptainer" >> "$GITHUB_ENV"

      - name: Build IGV SIF
        if: matrix.runtime == 'apptainer'
        shell: bash -l {0}
        env:
          APPTAINER_CACHEDIR: ${{ github.workspace }}/igv_runtime/apptainer_cache
          APPTAINER_TMPDIR: ${{ github.workspace }}/igv_runtime/apptainer_tmp
        run: |
          mkdir -p igv_runtime/apptainer_cache igv_runtime/apptainer_tmp
          "${APPTAINER:-apptainer}" pull igv_runtime/igv_snapper.sif docker://${{ env.MCP_IGV_CONTAINER_IMAGE }}

      - name: Create snapshot output directory
        run: mkdir -p igv_snapshots

      - name: Integration tests (full suite, docker)
        if: matrix.runtime == 'docker'
        shell: bash -l {0}
        env:
          IGV_SNAPSHOT_DIR: ${{ github.workspace }}/igv_snapshots
        run: pytest -m "integration or igv_integration or not integration" -ra

      - name: Integration tests (full suite, apptainer)
        if: matrix.runtime == 'apptainer'
        shell: bash -l {0}
        env:
          IGV_SNAPSHOT_DIR: ${{ github.workspace }}/igv_snapshots
          DOCKER: __no_docker__
          MCP_IGV_SIF_PATH: ${{ github.workspace }}/igv_runtime/igv_snapper.sif
          APPTAINER_CACHEDIR: ${{ github.workspace }}/igv_runtime/apptainer_cache
          APPTAINER_TMPDIR: ${{ github.workspace }}/igv_runtime/apptainer_tmp
        run: pytest -m "integration or igv_integration or not integration" -ra

      - name: Upload IGV snapshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: igv-snapshots-${{ matrix.runtime }}-${{ matrix.arch }}
          path: igv_snapshots/
          if-no-files-found: ignore
          retention-days: 7
