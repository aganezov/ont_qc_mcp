name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[all]"

      - name: Ruff lint
        run: ruff check .

      - name: Type check (mypy)
        run: mypy ont_qc_mcp tests

      - name: Security scan (bandit)
        run: bandit -r ont_qc_mcp -x tests

      - name: Dependency audit (pip-audit)
        run: pip-audit

      - name: Unit tests (skip integration)
        run: pytest --cov=ont_qc_mcp --cov-report=xml

  integration:
    runs-on: ubuntu-latest
    env:
      MCP_IGV_MOCK: "0"
      MCP_IGV_CONTAINER_IMAGE: "aganezov/igv_snapper:0.2"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up micromamba with bioinformatics CLIs
        uses: mamba-org/setup-micromamba@v1
        with:
          micromamba-version: "latest"
          environment-name: ci
          activate-environment: ci
          condarc: |
            channels:
              - conda-forge
              - bioconda
            channel_priority: strict
          create-args: >-
            python=3.11 chopper cramino mosdepth samtools
          cache-environment: true
          cache-downloads: true

      - name: Set up Rust (for nanoq)
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        shell: bash -l {0}
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[all]"

      - name: Install nanoq via cargo
        shell: bash -l {0}
        run: cargo install --locked nanoq

      - name: Check installed CLI versions
        shell: bash -l {0}
        run: |
          chopper --version
          cramino --version
          mosdepth --version
          samtools --version
          nanoq --version

      - name: Pull IGV container image
        run: docker pull ${{ env.MCP_IGV_CONTAINER_IMAGE }}

      - name: Create snapshot output directory
        run: mkdir -p igv_snapshots

      - name: Integration tests (full suite)
        shell: bash -l {0}
        env:
          IGV_SNAPSHOT_DIR: ${{ github.workspace }}/igv_snapshots
        run: pytest -m "integration or igv_integration or not integration" -ra

      - name: Upload IGV snapshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: igv-snapshots
          path: igv_snapshots/
          if-no-files-found: ignore
          retention-days: 7

